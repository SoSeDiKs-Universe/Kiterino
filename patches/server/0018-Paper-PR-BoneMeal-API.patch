From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Owen1212055 <23108066+Owen1212055@users.noreply.github.com>
Date: Sun, 17 Oct 2021 14:53:35 -0400
Subject: [PATCH] Paper PR - BoneMeal API


diff --git a/src/main/java/net/minecraft/world/item/BoneMealItem.java b/src/main/java/net/minecraft/world/item/BoneMealItem.java
index 8769e3cc4109bcc12d2758aa32db920f4dbae6e4..1bffb34c88ebb472684f6b0cf04617e0b448556a 100644
--- a/src/main/java/net/minecraft/world/item/BoneMealItem.java
+++ b/src/main/java/net/minecraft/world/item/BoneMealItem.java
@@ -39,14 +39,21 @@ public class BoneMealItem extends Item {
     }
 
     public static InteractionResult applyBonemeal(UseOnContext itemactioncontext) {
+        // Paper start - BoneMeal API
+        return applyBonemeal(itemactioncontext, true);
+    }
+    public static InteractionResult applyBonemeal(UseOnContext itemactioncontext, boolean showParticles) {
+        // Paper end - BoneMeal API
         // CraftBukkit end
         Level world = itemactioncontext.getLevel();
         BlockPos blockposition = itemactioncontext.getClickedPos();
         BlockPos blockposition1 = blockposition.relative(itemactioncontext.getClickedFace());
 
         if (BoneMealItem.growCrop(itemactioncontext.getItemInHand(), world, blockposition)) {
-            if (!world.isClientSide) {
-                itemactioncontext.getPlayer().gameEvent(GameEvent.ITEM_INTERACT_FINISH);
+            if (showParticles && !world.isClientSide) { // Paper - BoneMeal API
+                if (itemactioncontext.getPlayer() != null) {
+                    itemactioncontext.getPlayer().gameEvent(GameEvent.ITEM_INTERACT_FINISH);
+                }
                 world.levelEvent(1505, blockposition, 0);
             }
 
@@ -56,8 +63,10 @@ public class BoneMealItem extends Item {
             boolean flag = iblockdata.isFaceSturdy(world, blockposition, itemactioncontext.getClickedFace());
 
             if (flag && BoneMealItem.growWaterPlant(itemactioncontext.getItemInHand(), world, blockposition1, itemactioncontext.getClickedFace())) {
-                if (!world.isClientSide) {
-                    itemactioncontext.getPlayer().gameEvent(GameEvent.ITEM_INTERACT_FINISH);
+                if (showParticles && !world.isClientSide) { // Paper - BoneMeal API
+                    if (itemactioncontext.getPlayer() != null) {
+                        itemactioncontext.getPlayer().gameEvent(GameEvent.ITEM_INTERACT_FINISH);
+                    }
                     world.levelEvent(1505, blockposition1, 0);
                 }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index f93e63ae9952e409abf34ead9d46a909940af554..41651ba46f438cb776eb78bd4435c0ba03fbe832 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -2507,5 +2507,43 @@ public class CraftWorld extends CraftRegionAccessor implements World {
 
         return this.adventure$pointers;
     }
+
+    @Override
+    public boolean applyBoneMeal(@org.jetbrains.annotations.NotNull Location location, org.bukkit.block.BlockFace face, boolean showParticles, @org.jetbrains.annotations.Nullable Predicate<BlockState> predicate) {
+        BlockPos pos = new BlockPos(location.getBlockX(), location.getBlockY(), location.getBlockZ());
+        net.minecraft.world.item.context.UseOnContext context = new net.minecraft.world.item.context.UseOnContext(this.getHandle(), null, net.minecraft.world.InteractionHand.MAIN_HAND, net.minecraft.world.item.Items.BONE_MEAL.getDefaultInstance(), new net.minecraft.world.phys.BlockHitResult(Vec3.ZERO, CraftBlock.blockFaceToNotch(face), pos, false));
+
+        // Save old capturing state
+        boolean wasCapturingTrees = world.captureTreeGeneration;
+        boolean wasCapturingBlockStates = world.captureBlockStates;
+
+        Map<BlockPos, org.bukkit.craftbukkit.block.CraftBlockState> capturedBlocks = world.capturedBlockStates;
+        Map<BlockPos, net.minecraft.world.level.block.entity.BlockEntity> capturedTileEntities = world.capturedTileEntities;
+
+        // Create new state, capture everything
+        world.capturedBlockStates = new java.util.LinkedHashMap<>();
+        world.capturedTileEntities = new java.util.LinkedHashMap<>();
+
+        world.captureTreeGeneration = true;
+        world.captureBlockStates = true;
+
+        net.minecraft.world.InteractionResult result = net.minecraft.world.item.BoneMealItem.applyBonemeal(context, showParticles);
+
+        // Revert back booleans
+        world.captureTreeGeneration = wasCapturingTrees;
+        world.captureBlockStates = wasCapturingBlockStates;
+
+        for (BlockState blockState : world.capturedBlockStates.values()) {
+            if (predicate != null && predicate.test(blockState)) {
+                blockState.update(true);
+            }
+        }
+
+        // Revertback maps
+        world.capturedBlockStates = capturedBlocks;
+        world.capturedTileEntities = capturedTileEntities;
+
+        return result == net.minecraft.world.InteractionResult.CONSUME;
+    }
     // Paper end
 }
